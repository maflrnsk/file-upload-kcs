name: Sync Issue to BookStack KCS

on:
  issues:
    types: [opened, edited, closed, labeled, unlabeled]

jobs:
  sync_to_bookstack:
    runs-on: ubuntu-latest
    
    # Проверяем наличие метки upload-bug
    if: |
      contains(github.event.issue.labels.*.name, 'upload-bug')
    
    steps:
      - name: Debug - Check issue labels
        run: |
          echo "Issue labels: ${{ toJSON(github.event.issue.labels) }}"
          echo "Issue has upload-bug label: ${{ contains(github.event.issue.labels.*.name, 'upload-bug') }}"
      
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Setup Node.js environment
        uses: actions/setup-node@v3
        with:
          node-version: '18'

      - name: Parse Issue and Generate HTML
        id: parse_issue
        # Используем отдельный JavaScript файл
        run: node .github/scripts/parse-issue.js
        env:
          ISSUE_DATA: ${{ toJSON(github.event.issue) }}

      - name: Create/Update Page in BookStack
        env:
          BASE_URL: ${{ secrets.BOOKSTACK_BASE_URL }}
          TOKEN_ID: ${{ secrets.BOOKSTACK_TOKEN_ID }}
          TOKEN_SECRET: ${{ secrets.BOOKSTACK_TOKEN_SECRET }}
          AUTHOR_ID: ${{ secrets.BOOKSTACK_AUTHOR_ID }}
          BOOK_ID: ${{ secrets.BOOKSTACK_BOOK_ID }}
          PAGE_TITLE: ${{ steps.parse_issue.outputs.title }}
          PAGE_HTML: ${{ steps.parse_issue.outputs.html }}
          PAGE_TAGS: ${{ steps.parse_issue.outputs.tags }}
          ISSUE_NUMBER: ${{ steps.parse_issue.outputs.issue_number }}
        run: |
          echo "Starting BookStack sync for issue #${ISSUE_NUMBER}"
          
          # Ищем существующую страницу по тегу issue-{number}
          echo "Searching for existing page with tag: issue-${ISSUE_NUMBER}"
          
          SEARCH_URL="${BASE_URL}/api/pages?filter[tag]=issue-${ISSUE_NUMBER}"
          echo "Search URL: ${SEARCH_URL}"
          
          SEARCH_RESPONSE=$(curl -s -X GET \
            -H "Authorization: Token ${TOKEN_ID}:${TOKEN_SECRET}" \
            -H "Content-Type: application/json" \
            "$SEARCH_URL")
          
          echo "Search response received"
          
          # Извлекаем ID существующей страницы
          EXISTING_PAGE_ID=$(echo "$SEARCH_RESPONSE" | grep -o '"id":[0-9]*' | head -1 | cut -d: -f2)
          
          if [ -n "$EXISTING_PAGE_ID" ]; then
            echo "Found existing page ID: ${EXISTING_PAGE_ID}"
          else
            echo "No existing page found, will create new one"
          fi
          
          # Подготавливаем JSON данные
          JSON_DATA=$(cat <<EOF
          {
            "name": "$PAGE_TITLE",
            "book_id": $BOOK_ID,
            "html": "$PAGE_HTML",
            "tags": $PAGE_TAGS
          }
EOF
          )
          
          if [ -z "$EXISTING_PAGE_ID" ]; then
            # Создаем новую страницу
            echo "Creating new page..."
            
            RESPONSE=$(curl -s -w "\nHTTP_STATUS:%{http_code}" -X POST \
              -H "Authorization: Token ${TOKEN_ID}:${TOKEN_SECRET}" \
              -H "Content-Type: application/json" \
              -d "$JSON_DATA" \
              "${BASE_URL}/api/pages")
              
            # Извлекаем HTTP статус
            HTTP_CODE=$(echo "$RESPONSE" | grep "HTTP_STATUS:" | cut -d: -f2)
            RESPONSE_BODY=$(echo "$RESPONSE" | sed '/HTTP_STATUS:/d')
            
            echo "HTTP Status: ${HTTP_CODE}"
            
            if [ "$HTTP_CODE" = "200" ] || [ "$HTTP_CODE" = "201" ]; then
              PAGE_ID=$(echo "$RESPONSE_BODY" | grep -o '"id":[0-9]*' | head -1 | cut -d: -f2)
              echo "✅ Page created successfully! ID: ${PAGE_ID}"
              echo "Link: ${BASE_URL}/books/kcs/page/${PAGE_ID}"
            else
              echo "❌ Failed to create page"
              echo "Response: ${RESPONSE_BODY}"
              exit 1
            fi
          else
            # Обновляем существующую страницу
            echo "Updating existing page (ID: ${EXISTING_PAGE_ID})..."
            
            RESPONSE=$(curl -s -w "\nHTTP_STATUS:%{http_code}" -X PUT \
              -H "Authorization: Token ${TOKEN_ID}:${TOKEN_SECRET}" \
              -H "Content-Type: application/json" \
              -d "$JSON_DATA" \
              "${BASE_URL}/api/pages/${EXISTING_PAGE_ID}")
              
            HTTP_CODE=$(echo "$RESPONSE" | grep "HTTP_STATUS:" | cut -d: -f2)
            RESPONSE_BODY=$(echo "$RESPONSE" | sed '/HTTP_STATUS:/d')
            
            echo "HTTP Status: ${HTTP_CODE}"
            
            if [ "$HTTP_CODE" = "200" ] || [ "$HTTP_CODE" = "204" ]; then
              echo "✅ Page updated successfully! ID: ${EXISTING_PAGE_ID}"
              echo "Link: ${BASE_URL}/books/kcs/page/${EXISTING_PAGE_ID}"
            else
              echo "❌ Failed to update page"
              echo "Response: ${RESPONSE_BODY}"
              exit 1
            fi
          fi
          
          echo "✅ Sync completed successfully!"
